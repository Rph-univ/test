<!DOCTYPE html>
<html>
<head>
    <title>Etude Psychologique</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    <meta name="viewport" content="width=850"> <style>
        body { background-color: #f0f2f5; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        
        /* Cadre agrandi pour plus d'espace */
        .game-canvas { position: relative; width: 800px; height: 550px; background: white; border-radius: 20px; border: 2px solid #ddd; margin: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        /* Personnages beaucoup plus gros (140px au lieu de 70px) */
        .player { position: absolute; width: 160px; text-align: center; font-size: 20px; font-weight: bold; transition: transform 0.2s; }
        .player img { width: 130px; height: 130px; border-radius: 50%; background: #eee; border: 5px solid #ccc; }
        
        .cliquable { cursor: pointer; }
        .cliquable:hover { transform: scale(1.1); }
        
        /* Bordure bleue plus épaisse pour être bien visible */
        .cliquable img { border-color: #007aff; box-shadow: 0 0 25px rgba(0,122,255,0.6); border-width: 6px; }
        
        /* Positions ajustées pour le nouveau cadre de 800px */
        #pos-julie { top: 20px; left: 320px; }
        #pos-marc { top: 350px; left: 40px; }
        #pos-vous { top: 350px; right: 40px; }
        
        /* Balle un peu plus grosse pour la visibilité */
        #ball-sprite { position: absolute; width: 35px; height: 35px; background: radial-gradient(circle, #ff9500, #ff5e00); border-radius: 50%; transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1); z-index: 99; top: 120px; left: 382px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        
        .ui-box { margin-top: 20px; height: 50px; text-align: center; color: #007aff; font-size: 24px; font-weight: bold; }
        .welcome-box { text-align: center; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); max-width: 600px; }
        
        /* Boutons JSpsych plus gros */
        .jspsych-btn { font-size: 22px !important; padding: 15px 40px !important; }
        
        .connect-container { display: flex; justify-content: space-around; margin: 30px 0; min-height: 120px; }
        .connect-card { opacity: 0.2; transition: opacity 0.5s; text-align: center; font-size: 16px; }
        .connect-card.active { opacity: 1; }
        .connect-card img { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #2ecc71; display: block; margin-bottom: 10px; }
        .status-dot { color: #2ecc71; font-weight: bold; }
        .loader { border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <script>
        const totalPassesMax = 40; 
        const jsPsych = initJsPsych({
            on_finish: function() {
                document.body.innerHTML = `
                    <div style="text-align:center; padding:50px; background:white; border-radius:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1); font-family:sans-serif; max-width: 700px;">
                        <h2 style="color: #2ecc71; font-size: 32px;">Partie terminée</h2>
                        <p style="font-size: 24px;">Merci pour votre participation.</p>
                        <p style="font-size: 20px; color: #555;">Vous pouvez maintenant fermer cette fenêtre et retourner sur le questionnaire.</p>
                    </div>`;
            }
        });

        let passesCompteur = 0;

        const welcome = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="welcome-box">
                    <p style="font-size: 24px; font-weight: bold;">Prêt pour le jeu ?</p>
                    <p style="font-size: 18px; color: #555;">Cliquez sur l'image d'un joueur pour lui envoyer la balle.</p>
                </div>`,
            choices: ['COMMENCER']
        };

        const connection = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="welcome-box">
                    <h3 style="font-size: 24px;">Connexion des joueurs...</h3>
                    <div class="connect-container">
                        <div class="connect-card active"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=User">Vous<br><span class="status-dot">● Prêt</span></div>
                        <div id="card-julie" class="connect-card"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Julie">Julie<br><span id="status-julie">...</span></div>
                        <div id="card-marc" class="connect-card"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Marc">Marc<br><span id="status-marc">...</span></div>
                    </div>
                    <div id="global-loader" class="loader"></div>
                </div>`,
            choices: [],
            trial_duration: 6000,
            on_load: function() {
                setTimeout(() => { document.getElementById('card-julie').classList.add('active'); document.getElementById('status-julie').innerHTML = "● Connecté"; }, 1800);
                setTimeout(() => { document.getElementById('card-marc').classList.add('active'); document.getElementById('status-marc').innerHTML = "● Connecté"; document.getElementById('global-loader').style.display = "none"; }, 3800);
            }
        };

        const game_trial = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `<div class="game-canvas" id="main-canvas">
                    <div id="pos-julie" class="player"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Julie"><br>Julie</div>
                    <div id="pos-marc" class="player"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Marc"><br>Marc</div>
                    <div id="pos-vous" class="player"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=User"><br>Vous</div>
                    <div id="ball-sprite"></div>
                </div><div class="ui-box"><p id="instruction"></p></div>`,
            choices: [],
            on_load: function() {
                const ball = document.getElementById('ball-sprite');
                const players = {
                    'julie': document.getElementById('pos-julie'),
                    'marc': document.getElementById('pos-marc'),
                    'vous': document.getElementById('pos-vous')
                };
                const instr = document.getElementById('instruction');

                function getCenter(el) {
                    const rect = el.getBoundingClientRect();
                    const canvas = document.getElementById('main-canvas').getBoundingClientRect();
                    return {
                        x: (rect.left + rect.width / 2) - canvas.left - 17, // -17 pour centrer la balle de 35px
                        y: (rect.top + rect.height / 2) - canvas.top - 17
                    };
                }

                function move(targetId) {
                    const coords = getCenter(players[targetId]);
                    ball.style.left = coords.x + 'px';
                    ball.style.top = coords.y + 'px';
                    passesCompteur++;

                    players['julie'].classList.remove('cliquable');
                    players['marc'].classList.remove('cliquable');
                    players['julie'].onclick = null;
                    players['marc'].onclick = null;

                    if (passesCompteur >= totalPassesMax) {
                        setTimeout(() => jsPsych.finishTrial(), 2500);
                        return;
                    }

                    if (targetId === 'vous') {
                        instr.innerHTML = "À VOUS DE JOUER !";
                        setTimeout(() => {
                            players['julie'].classList.add('cliquable');
                            players['marc'].classList.add('cliquable');
                            players['julie'].onclick = () => move('julie');
                            players['marc'].onclick = () => move('marc');
                        }, 1300); 
                    } else {
                        instr.innerHTML = "";
                        setTimeout(() => {
                            let next;
                            if (passesCompteur <= 15) {
                                next = Math.random() < 0.33 ? 'vous' : (targetId === 'julie' ? 'marc' : 'julie');
                            } else {
                                next = Math.random() < 0.05 ? 'vous' : (targetId === 'julie' ? 'marc' : 'julie');
                            }
                            move(next);
                        }, 2500);
                    }
                }

                // Placement initial sur Julie
                const initPos = getCenter(players['julie']);
                ball.style.left = initPos.x + 'px';
                ball.style.top = initPos.y + 'px';
                setTimeout(() => move('marc'), 1500);
            }
        };

        jsPsych.run([welcome, connection, game_trial]);
    </script>
</body>
</html>
